# Документация по приложению для фильтрации n-грамм

## 1. Назначение приложения

Это интерактивное веб-приложение, созданное с помощью Streamlit, предназначено для сложной фильтрации и анализа синтаксических n-грамм (последовательностей слов), хранящихся в базе данных PostgreSQL. Оно позволяет пользователям динамически конструировать запросы, чтобы находить фразы, соответствующие определённым лингвистическим шаблонам.

## 2. Основные функции

- **Динамическая фильтрация:** Создание многоуровневых правил фильтрации на основе длины фразы и характеристик каждого слова в ней (токен, лемма, часть речи, тег, синтаксическая зависимость, морфологические признаки).
- **Сохранение и загрузка:** Возможность сохранять и загружать как целые наборы фильтров, так и отдельные блоки правил для повторного использования.
- **Просмотр SQL-запроса:** Приложение показывает сгенерированный SQL-запрос, что обеспечивает прозрачность и помогает в отладке.
- **Анализ результатов:** После получения отфильтрованных фраз можно провести частотный анализ слов на каждой позиции.
- **Кэширование:** Для ускорения работы повторяющиеся запросы к базе данных кэшируются.

## 3. Как запустить приложение

### 3.1. Предварительные требования

1.  **Python:** Убедитесь, что у вас установлен Python (версия 3.8 или выше).
2.  **PostgreSQL:** Необходимо иметь работающий сервер PostgreSQL с базой данных, содержащей n-граммы. Структура данных описана в разделе 7.
3.  **Установка зависимостей:** Установите все необходимые библиотеки, выполнив команду в терминале:
    ```bash
    pip install -r requirements.txt
    ```

### 3.2. Конфигурация

Перед запуском необходимо указать корректные данные для подключения к вашей базе данных в файле `streamlit_app.py`:

```python
# --- Конфигурация и подключение к БД ---
DB_HOST = "localhost"
DB_NAME = "ngrams_2_0"
DB_USER = "postgres"
DB_PASSWORD = "ВАШ_ПАРОЛЬ" # Замените на ваш пароль
```

### 3.3. Запуск

Для запуска приложения выполните в терминале следующую команду, находясь в директории с файлом `streamlit_app.py`:

```bash
streamlit run streamlit_app.py
```

После этого в вашем браузере откроется страница с приложением.

## 4. Интерфейс приложения

Интерфейс разделен на две основные колонки:

-   **Левая колонка (Панель управления):** Здесь находятся все элементы для настройки фильтров.
-   **Правая колонка (Область результатов):** Здесь отображаются результаты выполнения запроса.

## 5. Процесс работы (Workflow)

### Шаг 1: Выбор длины фразы

В самом верху левой колонки выберите одну или несколько длин фраз (в токенах), которые вас интересуют. Это основной параметр, от которого зависит дальнейшая настройка.

### Шаг 2: Создание блоков фильтров

-   Нажмите кнопку **"Добавить блок фильтров"**. Каждый блок соответствует одному слову (токену) в фразе.
-   Для каждого блока можно задать **позицию** слова, к которому будут применяться правила внутри этого блока (например, 1-е слово, 2-е и т.д.).

### Шаг 3: Настройка правил в блоках

-   Внутри каждого блока можно добавить одно или несколько правил, нажав **"➕ Добавить правило"**.
-   Каждое правило состоит из:
    -   **Типа:** Атрибут слова (`dep`, `pos`, `tag`, `token`, `lemma`, `morph`).
    -   **Значения:** Конкретные значения для выбранного типа. Список доступных значений формируется динамически на основе данных в БД и уже примененных фильтров. Можно выбрать несколько значений.
-   Правила внутри одного блока объединяются по логическому "И". Блоки между собой также объединяются по "И".

### Шаг 4: Применение фильтров и просмотр результатов

-   После настройки всех правил нажмите кнопку **"Применить фильтры"**.
-   В правой колонке появится таблица с результатами, содержащая найденные фразы и их частотность.

### Шаг 5: Анализ слов по позициям

-   Если результаты найдены, под таблицей появится кнопка **"Анализ слов по позициям"**.
-   Нажатие на нее открывает детальный отчет, показывающий самые частотные слова для каждой позиции в найденных фразах.

## 6. Управление наборами и блоками

### 6.1. Наборы фильтров

-   **Сохранить набор:** Позволяет сохранить всю текущую конфигурацию (выбранные длины и все блоки с правилами) под уникальным именем.
-   **Загрузить набор:** Позволяет загрузить ранее сохраненную конфигурацию или удалить ее.

### 6.2. Шаблоны блоков

-   Кнопка **"Управление"** в заголовке каждого блока открывает диалоговое окно.
-   В этом окне можно:
    -   **Сохранить текущий блок** как шаблон для будущего использования.
    -   **Загрузить** ранее сохраненный шаблон в текущий блок, заменяя его содержимое.
    -   **Удалить** сохраненный шаблон.

## 7. Технические детали

### 7.1. Структура таблиц БД

Приложение ожидает наличие в базе данных как минимум трех таблиц:

1.  `ngrams`: Основная таблица с данными.
    -   `id`: Уникальный идентификатор.
    -   `text` (TEXT): Текст n-граммы.
    -   `len` (INTEGER): Длина n-граммы в токенах.
    -   `freq_mln` (NUMERIC): Нормализованная частота (на миллион).
    -   `frequency` (INTEGER): Абсолютная частота.
    -   `tokens` (JSONB): Массив токенов. `["слово1", "слово2"]`
    -   `lemmas` (JSONB): Массив лемм. `["лемма1", "лемма2"]`
    -   `pos` (JSONB): Массив частей речи. `["NOUN", "VERB"]`
    -   `tags` (JSONB): Массив грамматических тегов. `["Animacy=Anim", "Aspect=Imp"]`
    -   `deps` (JSONB): Массив синтаксических зависимостей. `["nsubj", "root"]`
    -   `morph` (JSONB): Массив полных морфологических признаков в формате вложенных JSON. `[{"Feat1": "Val1"}, {"Feat2": "Val2"}]`

2.  `saved_filters`: Таблица для хранения наборов фильтров.
    -   `name` (TEXT, PRIMARY KEY): Уникальное имя набора.
    -   `filters_json` (JSONB): JSON-объект с сохраненными параметрами.

3.  `saved_blocks`: Таблица для хранения шаблонов блоков.
    -   `name` (TEXT, PRIMARY KEY): Уникальное имя шаблона.
    -   `block_json` (JSONB): JSON-объект с сохраненным блоком.
